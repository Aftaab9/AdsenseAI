// AdsenseAI - Optimized & Minified JavaScript
// State management
const state={platform:null,image:null,influencer:!1,charts:{tpb:null,sentiment:null,risk:null}};

// DOM element cache
const dom={};
function cacheDOM(){const ids=['caption','charCount','platform','postingDate','influencerToggle','influencerLabel','influencer','imageUploadZone','imageInput','imagePreview','imagePreviewContainer','removeImage','campaignForm','analyzeBtn','loadingOverlay','resultsSection','captionRequired','imageOnlyIndicator'];ids.forEach(id=>dom[id]=document.getElementById(id));dom.platformBtns=document.querySelectorAll('.platform-btn');dom.exampleBtns=document.querySelectorAll('.example-btn');}

// Examples data
const examples={safe:{caption:"Celebrating India's diversity this Diwali! ü™î Join us in spreading joy and light across the nation. May this festival bring happiness to every home. #HappyDiwali #IndianFestival #UnityInDiversity",platform:"Instagram"},moderate:{caption:"Enjoy our special meat dishes this festive season! Limited time offer on all non-veg items. Order now and get 20% off! #FestiveFood #SpecialOffer",platform:"Instagram"},risky:{caption:"Fair skin is the key to beauty! Get our whitening cream now and transform your complexion. Be fair, be beautiful! #FairSkin #BeautyStandards",platform:"Twitter"}};

// Event handlers
function setupEventListeners(){dom.caption.addEventListener('input',()=>{const len=dom.caption.value.length;dom.charCount.textContent=len;dom.charCount.style.color=len>500?'var(--warning)':len>1000?'var(--danger)':'var(--text-muted)';validateForm();});dom.platformBtns.forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();dom.platformBtns.forEach(b=>b.classList.remove('active'));btn.classList.add('active');state.platform=btn.dataset.platform;dom.platform.value=state.platform;validateForm();}));dom.influencerToggle.addEventListener('click',()=>{state.influencer=!state.influencer;dom.influencerToggle.classList.toggle('active',state.influencer);dom.influencerLabel.textContent=state.influencer?'Yes':'No';dom.influencer.value=state.influencer;});dom.imageUploadZone.addEventListener('click',()=>dom.imageInput.click());dom.imageUploadZone.addEventListener('dragover',e=>{e.preventDefault();dom.imageUploadZone.classList.add('drag-over');});dom.imageUploadZone.addEventListener('dragleave',()=>dom.imageUploadZone.classList.remove('drag-over'));dom.imageUploadZone.addEventListener('drop',e=>{e.preventDefault();dom.imageUploadZone.classList.remove('drag-over');const file=e.dataTransfer.files[0];if(file&&file.type.startsWith('image/'))handleImageFile(file);});dom.imageInput.addEventListener('change',e=>{if(e.target.files[0])handleImageFile(e.target.files[0]);});dom.removeImage.addEventListener('click',()=>{state.image=null;dom.imagePreviewContainer.classList.remove('show');dom.imageInput.value='';validateForm();});dom.exampleBtns.forEach(btn=>btn.addEventListener('click',()=>{const ex=examples[btn.dataset.example];if(ex){dom.caption.value=ex.caption;dom.charCount.textContent=ex.caption.length;dom.platformBtns.forEach(b=>b.classList.toggle('active',b.dataset.platform===ex.platform));state.platform=ex.platform;dom.platform.value=ex.platform;validateForm();dom.caption.scrollIntoView({behavior:'smooth',block:'center'});}}));dom.campaignForm.addEventListener('submit',handleSubmit);}

function handleImageFile(file){if(file.size>10*1024*1024){showNotification('Image too large. Max 10MB allowed.','error');return;}const reader=new FileReader();reader.onload=e=>{state.image=e.target.result;dom.imagePreview.src=state.image;dom.imagePreviewContainer.classList.add('show');validateForm();};reader.readAsDataURL(file);}

function validateForm(){const hasCaption=dom.caption.value.trim().length>0;const hasImage=state.image!==null;const hasPlatform=state.platform!==null;const valid=(hasCaption||hasImage)&&hasPlatform;dom.analyzeBtn.disabled=!valid;if(hasImage&&!hasCaption){dom.captionRequired.style.display='none';dom.imageOnlyIndicator.classList.remove('hidden');}else{dom.captionRequired.style.display=hasImage?'none':'inline';dom.imageOnlyIndicator.classList.add('hidden');}return valid;}

async function handleSubmit(e){e.preventDefault();if(!validateForm())return;const selectedPersonas=window.PersonaTesting?window.PersonaTesting.getSelectedPersonas():[];const captionText=dom.caption.value.trim();const isImageOnly=!captionText&&state.image;const requestData={caption:captionText||null,platform:state.platform,posting_date:dom.postingDate.value||null,influencer:state.influencer,image_base64:state.image||null,persona_ids:selectedPersonas.length>0?selectedPersonas:null,image_only:isImageOnly};showLoading(isImageOnly?'Extracting text and analyzing image...':'Analyzing your campaign with AI...');try{const response=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestData)});if(!response.ok){const err=await response.json().catch(()=>({}));throw new Error(err.detail||`Server error: ${response.status}`);}const data=await response.json();displayResults(data,isImageOnly);}catch(error){console.error('Analysis error:',error);showNotification(error.message||'Analysis failed. Please try again.','error');}finally{hideLoading();}}

function showLoading(msg='Analyzing your campaign with AI...'){dom.loadingOverlay.classList.add('show');dom.analyzeBtn.disabled=!0;const loadingText=dom.loadingOverlay.querySelector('.loading-text');if(loadingText)loadingText.textContent=msg;}

function hideLoading(){dom.loadingOverlay.classList.remove('show');dom.analyzeBtn.disabled=!1;}

function showNotification(msg,type='info'){const notification=document.createElement('div');notification.style.cssText=`position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:12px;color:white;font-weight:500;z-index:2000;animation:slideIn 0.3s ease-out;max-width:400px;backdrop-filter:blur(10px);${type==='error'?'background:rgba(244,92,67,0.9);':'background:rgba(102,126,234,0.9);'}`;notification.textContent=msg;document.body.appendChild(notification);setTimeout(()=>{notification.style.animation='slideOut 0.3s ease-out';setTimeout(()=>notification.remove(),300);},4000);}

function displayResults(data,isImageOnly=!1){dom.resultsSection.classList.add('show');setTimeout(()=>dom.resultsSection.scrollIntoView({behavior:'smooth',block:'start'}),100);if(isImageOnly&&data.image_analysis){showNotification('üì∑ Analysis based on image content'+(data.image_analysis.text_overlay?' and extracted text':''),'info');}displayRecommendation(data.recommendation);animateScore('viralityScore',data.virality_score);animateScore('backlashScore',data.backlash_risk);animateScore('fatigueScore',data.ad_fatigue_risk);animateScore('exposureScore',data.exposure_intensity);createTPBRadarChart(data.tpb_scores);createSentimentDonutChart(data.sentiment);createRiskComparisonChart(data.virality_score,data.backlash_risk,data.ad_fatigue_risk,data.exposure_intensity);updateRiskGauge(data.backlash_risk);displayContentScores(data);displayAlerts(data.cultural_alerts);displaySuggestions(data.recommendation.suggestions||[]);displayReasoning(data.recommendation.reasoning||[]);displayCampaigns(data.similar_campaigns||[]);if(data.image_analysis){displayImageInsights(data.image_analysis);}else{document.getElementById('imageInsightsSection').classList.add('hidden');}if(data.persona_analysis&&data.persona_analysis.persona_results&&window.PersonaTesting){window.PersonaTesting.displayResults(data.persona_analysis.persona_results);}else{document.getElementById('audienceResponseSection').classList.add('hidden');}}

function displayRecommendation(rec){const hero=document.getElementById('recommendationHero');const icon=document.getElementById('recommendationIcon');const title=document.getElementById('recommendationTitle');const message=document.getElementById('recommendationMessage');hero.className='recommendation-hero '+rec.status;const icons={go:'üöÄ',caution:'‚ö†Ô∏è',stop:'üõë'};icon.textContent=icons[rec.status]||'üéØ';title.textContent=rec.action;message.textContent=rec.message;}

function animateScore(elementId,target){const el=document.getElementById(elementId);let current=0;const duration=1500;const steps=60;const increment=target/steps;const interval=setInterval(()=>{current+=increment;if(current>=target){current=target;clearInterval(interval);}el.textContent=Math.round(current);},duration/steps);}

function createTPBRadarChart(tpb){const ctx=document.getElementById('tpbRadarChart').getContext('2d');if(state.charts.tpb)state.charts.tpb.destroy();state.charts.tpb=new Chart(ctx,{type:'radar',data:{labels:['Attitude','Subjective Norms','Perceived Control','Behavioral Intention'],datasets:[{label:'TPB Scores',data:[tpb.attitude,tpb.subjective_norms,tpb.perceived_control,tpb.behavioral_intention],backgroundColor:'rgba(102,126,234,0.2)',borderColor:'rgba(102,126,234,1)',borderWidth:2,pointBackgroundColor:'rgba(102,126,234,1)',pointBorderColor:'#fff',pointHoverBackgroundColor:'#fff',pointHoverBorderColor:'rgba(102,126,234,1)'}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{r:{beginAtZero:!0,max:100,ticks:{color:'rgba(255,255,255,0.5)',backdropColor:'transparent'},grid:{color:'rgba(255,255,255,0.1)'},pointLabels:{color:'rgba(255,255,255,0.7)',font:{size:11}}}},plugins:{legend:{display:!1}}}});}

function createSentimentDonutChart(sentiment){const ctx=document.getElementById('sentimentDonutChart').getContext('2d');if(state.charts.sentiment)state.charts.sentiment.destroy();state.charts.sentiment=new Chart(ctx,{type:'doughnut',data:{labels:['Positive','Negative','Neutral'],datasets:[{data:[sentiment.positive,sentiment.negative,sentiment.neutral],backgroundColor:['rgba(56,239,125,0.8)','rgba(244,92,67,0.8)','rgba(156,163,175,0.8)'],borderColor:['rgba(56,239,125,1)','rgba(244,92,67,1)','rgba(156,163,175,1)'],borderWidth:2,hoverOffset:10}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:'60%',plugins:{legend:{position:'bottom',labels:{color:'rgba(255,255,255,0.7)',padding:15,usePointStyle:!0}},tooltip:{callbacks:{label:function(context){return context.label+': '+context.raw.toFixed(1)+'%';}}}}});}

function createRiskComparisonChart(virality,backlash,fatigue,exposure){const ctx=document.getElementById('riskComparisonChart').getContext('2d');if(state.charts.risk)state.charts.risk.destroy();state.charts.risk=new Chart(ctx,{type:'bar',data:{labels:['Virality','Backlash','Ad-Fatigue','Exposure'],datasets:[{label:'Score',data:[virality,backlash,fatigue,exposure],backgroundColor:['rgba(56,239,125,0.7)','rgba(244,92,67,0.7)','rgba(245,87,108,0.7)','rgba(79,172,254,0.7)'],borderColor:['rgba(56,239,125,1)','rgba(244,92,67,1)','rgba(245,87,108,1)','rgba(79,172,254,1)'],borderWidth:2,borderRadius:8,borderSkipped:!1}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:'y',scales:{x:{beginAtZero:!0,max:100,grid:{color:'rgba(255,255,255,0.1)'},ticks:{color:'rgba(255,255,255,0.5)'}},y:{grid:{display:!1},ticks:{color:'rgba(255,255,255,0.7)'}}},plugins:{legend:{display:!1}}}});}

function updateRiskGauge(backlashRisk){const gaugeFill=document.getElementById('gaugeFill');const gaugeValue=document.getElementById('gaugeValue');const gaugeLabel=document.getElementById('gaugeLabel');const riskInterpretation=document.getElementById('riskInterpretation');const arcLength=251;const offset=arcLength-(backlashRisk/100)*arcLength;setTimeout(()=>{gaugeFill.style.strokeDasharray=arcLength;gaugeFill.style.strokeDashoffset=offset;},100);gaugeValue.textContent=backlashRisk;if(backlashRisk>=70){gaugeLabel.textContent='HIGH RISK';riskInterpretation.textContent='‚ö†Ô∏è Critical backlash risk detected. Consider major revisions before launch.';}else if(backlashRisk>=40){gaugeLabel.textContent='MODERATE RISK';riskInterpretation.textContent='‚ö° Some risk factors present. Review suggestions and make adjustments.';}else{gaugeLabel.textContent='LOW RISK';riskInterpretation.textContent='‚úÖ Campaign appears safe. Minor optimizations may still help.';}}

function displayContentScores(data){const emcScore=data.emotional_moral_content?.emc_score||0;document.getElementById('emcValue').textContent=Math.round(emcScore);setTimeout(()=>document.getElementById('emcBar').style.width=emcScore+'%',100);const namScore=data.narrative_ambiguity?.nam_score||0;document.getElementById('namValue').textContent=Math.round(namScore);setTimeout(()=>document.getElementById('namBar').style.width=namScore+'%',150);const scsScore=data.socio_cultural_sensitivity?.scs_score||0;document.getElementById('scsValue').textContent=Math.round(scsScore);setTimeout(()=>document.getElementById('scsBar').style.width=scsScore+'%',200);const intentScore=data.perceived_intent?.intent_score||0;const normalizedIntent=(intentScore+100)/2;document.getElementById('intentValue').textContent=intentScore>0?'+'+Math.round(intentScore):Math.round(intentScore);setTimeout(()=>document.getElementById('intentBar').style.width=normalizedIntent+'%',250);}

function displayAlerts(alerts){const container=document.getElementById('alertsList');if(!alerts||alerts.length===0){container.innerHTML=`<div class="no-alerts"><div class="no-alerts-icon">‚úÖ</div><div>No cultural sensitivity issues detected</div></div>`;return;}const icons={critical:'üö®',high:'‚ö†Ô∏è',medium:'‚ÑπÔ∏è',low:'üí°'};container.innerHTML=alerts.map((alert,i)=>`<div class="alert-item ${alert.severity}" style="animation-delay:${i*0.1}s"><div class="alert-icon">${icons[alert.severity]||'‚ö†Ô∏è'}</div><div class="alert-content"><div class="alert-header"><span class="alert-keyword">"${alert.keyword}"</span><span class="alert-badge">${alert.severity}</span></div><div class="alert-message">${alert.message}</div><div class="alert-meta">Category: ${alert.category} ‚Ä¢ Risk Weight: ${alert.risk_weight}</div></div></div>`).join('');}

function displaySuggestions(suggestions){const section=document.getElementById('suggestionsSection');const list=document.getElementById('suggestionsList');if(!suggestions||suggestions.length===0){section.classList.add('hidden');return;}section.classList.remove('hidden');list.innerHTML=suggestions.map((s,i)=>`<div class="suggestion-item"><div class="suggestion-number">${i+1}</div><div class="suggestion-text">${s}</div></div>`).join('');}

function displayReasoning(reasoning){const list=document.getElementById('reasoningList');if(!reasoning||reasoning.length===0){list.innerHTML='<p>No detailed reasoning available.</p>';return;}list.innerHTML=`<ul style="margin-left:1.5rem;line-height:1.8;">${reasoning.map(r=>`<li>${r}</li>`).join('')}</ul>`;}

function displayCampaigns(campaigns){const container=document.getElementById('campaignsList');if(!campaigns||campaigns.length===0){container.innerHTML=`<div class="no-alerts" style="grid-column:1/-1;"><div class="no-alerts-icon">üì≠</div><div>No similar campaigns found</div></div>`;return;}container.innerHTML=campaigns.map(c=>`<div class="campaign-card"><div class="campaign-brand">${c.brand}</div><div class="campaign-name">${c.campaign}</div><div class="campaign-outcome ${c.outcome.toLowerCase().includes('success')?'success':'failure'}">${c.outcome.toLowerCase().includes('success')?'‚úì':'‚úó'} ${c.outcome}</div><div class="campaign-lesson">"${c.lesson}"</div></div>`).join('');}

function displayImageInsights(analysis){const section=document.getElementById('imageInsightsSection');if(!analysis||analysis.error){section.classList.add('hidden');return;}section.classList.remove('hidden');document.getElementById('visualEmotions').textContent=analysis.visual_emotions?.length>0?analysis.visual_emotions.join(', '):'None detected';document.getElementById('culturalSymbols').textContent=analysis.cultural_symbols?.length>0?analysis.cultural_symbols.join(', '):'None detected';document.getElementById('textOverlay').textContent=analysis.text_overlay||'None detected';document.getElementById('visualEMC').textContent=analysis.visual_emc_score?analysis.visual_emc_score+'/100':'N/A';}

// Add animation styles
const style=document.createElement('style');style.textContent=`@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}`;document.head.appendChild(style);

// Initialize on DOM ready
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>{cacheDOM();setupEventListeners();validateForm();});}else{cacheDOM();setupEventListeners();validateForm();}
